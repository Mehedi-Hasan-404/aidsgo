rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin (optional - requires custom claims)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // Categories Collection
    match /categories/{categoryId} {
      // Anyone can read categories (for the Android app)
      allow read: if true;
      
      // Only authenticated users can create/update/delete (for admin panel)
      allow create, update, delete: if isAuthenticated();
    }
    
    // Channels Collection
    match /channels/{channelId} {
      // Anyone can read channels (for the Android app)
      allow read: if true;
      
      // Only authenticated users can create/update/delete (for admin panel)
      allow create, update, delete: if isAuthenticated();
      
      // Validate channel data on create/update
      allow create, update: if isAuthenticated() && 
        request.resource.data.keys().hasAll(['name', 'logoUrl', 'streamUrl', 'categoryId', 'categoryName']) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.logoUrl is string &&
        request.resource.data.streamUrl is string &&
        request.resource.data.categoryId is string &&
        request.resource.data.categoryName is string;
    }
    
    // Live Events Collection
    match /live_events/{eventId} {
      // Anyone can read live events (for the Android app)
      allow read: if true;
      
      // Only authenticated users can create/update/delete (for admin panel)
      allow create, update, delete: if isAuthenticated();
      
      // Validate live event data on create/update
      allow create, update: if isAuthenticated() && 
        request.resource.data.keys().hasAll(['category', 'league', 'team1Name', 'team2Name', 'startTime', 'isLive', 'links']) &&
        request.resource.data.category is string &&
        request.resource.data.league is string &&
        request.resource.data.team1Name is string &&
        request.resource.data.team2Name is string &&
        request.resource.data.startTime is string &&
        request.resource.data.isLive is bool &&
        request.resource.data.links is list;
    }
    
    // User Favorites (optional - if you want to add cloud-based favorites)
    match /user_favorites/{userId} {
      // Users can only read/write their own favorites
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      match /channels/{channelId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // Admin Users Collection (optional)
    match /admin_users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if false; // Only allow through Firebase Admin SDK
    }
    
    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Storage Rules (for images/logos)
service firebase.storage {
  match /b/{bucket}/o {
    
    // Channel logos
    match /channel_logos/{fileName} {
      // Anyone can read
      allow read: if true;
      
      // Only authenticated users can upload
      allow write: if request.auth != null &&
        request.resource.size < 5 * 1024 * 1024 && // Max 5MB
        request.resource.contentType.matches('image/.*');
    }
    
    // Category icons
    match /category_icons/{fileName} {
      // Anyone can read
      allow read: if true;
      
      // Only authenticated users can upload
      allow write: if request.auth != null &&
        request.resource.size < 2 * 1024 * 1024 && // Max 2MB
        request.resource.contentType.matches('image/.*');
    }
    
    // Team logos for live events
    match /team_logos/{fileName} {
      // Anyone can read
      allow read: if true;
      
      // Only authenticated users can upload
      allow write: if request.auth != null &&
        request.resource.size < 3 * 1024 * 1024 && // Max 3MB
        request.resource.contentType.matches('image/.*');
    }
    
    // Deny all other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
